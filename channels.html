<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Xếp Hạng Kênh Nội Bộ | TikTok A-Z by Kiantr</title>
    <meta name="description" content="BXH kênh TikTok nội bộ, danh sách đầy đủ và bảng vinh danh học viên xuất sắc.">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-base: #1f1f28;
            --bg-surface: #24232d;
            --bg-surface-alt: #2d2c36;
            --primary: #f5c400;
            --primary-dark: #dba702;
            --text-primary: #f5f5f7;
            --text-muted: rgba(245, 245, 247, 0.68);
            --border: rgba(255, 255, 255, 0.08);
            --shadow-lg: 0 26px 60px rgba(0, 0, 0, 0.35);
            --shadow-md: 0 18px 40px rgba(0, 0, 0, 0.28);
        }

        body {
            background: var(--bg-base);
            color: var(--text-primary);
            font-family: 'Inter', 'Roboto', sans-serif;
            line-height: 1.6;
        }

        a {
            color: var(--primary);
        }

        a:hover,
        a:focus {
            color: var(--primary-dark);
        }

        .navbar {
            background: var(--bg-surface) !important;
            border-bottom: 1px solid var(--border);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            color: var(--text-primary) !important;
        }

        .nav-link {
            color: var(--text-muted) !important;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link:focus,
        .nav-link.active-page {
            color: var(--primary) !important;
        }

        .main-title {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-size: clamp(1.75rem, 3vw, 2.4rem);
            font-weight: 800;
            text-transform: uppercase;
            color: var(--primary);
            border-bottom: 3px solid var(--primary-dark);
            padding-bottom: 0.4rem;
        }

        .leaderboard-section {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 26px;
            padding: 2.5rem 2rem;
            box-shadow: var(--shadow-lg);
        }

        .leaderboard-title {
            font-weight: 800;
            font-size: 1.75rem;
            letter-spacing: 0.4px;
        }

        .leaderboard-description {
            color: var(--text-muted);
        }

        .podium-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .podium-card {
            background: var(--bg-surface-alt);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 1.6rem 1.25rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .podium-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .podium-card.rank-1 {
            background: linear-gradient(140deg, rgba(245, 196, 0, 0.95), rgba(245, 196, 0, 0.7));
            color: #1f1f28;
        }

        .podium-card.rank-1 .podium-handle,
        .podium-card.rank-1 .podium-meta small {
            color: rgba(31, 31, 40, 0.65);
        }

        .podium-rank {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .podium-card.rank-1 .podium-rank {
            color: #1f1f28;
        }

        .podium-avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            margin: 0 auto;
            overflow: hidden;
            border: 3px solid rgba(245, 196, 0, 0.55);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
            background: #0f0f0f;
        }

        .podium-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .podium-name {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0;
        }

        .podium-handle {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .podium-stats {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .metric-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.95rem;
            border-radius: 999px;
            background: rgba(245, 196, 0, 0.18);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary-dark);
        }

        .podium-card.rank-1 .metric-chip {
            background: rgba(31, 31, 40, 0.12);
            color: #1f1f28;
        }

        .podium-meta {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .podium-card .btn-watch {
            align-self: center;
            margin-top: auto;
        }

        .leaderboard-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 1rem 0;
            grid-column: 1 / -1;
        }

        .filter-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .form-label {
            color: var(--text-muted);
            font-weight: 600;
        }

        .form-select {
            background: var(--bg-surface-alt);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 14px;
            padding: 0.75rem 1rem;
        }

        .form-select:focus {
            border-color: rgba(245, 196, 0, 0.4);
            box-shadow: 0 0 0 0.2rem rgba(245, 196, 0, 0.15);
        }

        .channel-card {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 22px;
            padding: 1.6rem 2rem;
            box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .channel-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .channel-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid rgba(245, 196, 0, 0.55);
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
            background: #0f0f0f;
        }

        .channel-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .channel-content {
            flex: 1;
        }

        .channel-title-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .channel-name {
            font-weight: 700;
            font-size: 1.35rem;
            margin-bottom: 0.2rem;
        }

        .channel-handle {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-bottom: 0.6rem;
        }

        .channel-topic {
            font-size: 0.92rem;
            color: var(--text-muted);
            margin-bottom: 0.8rem;
        }

        .channel-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .channel-stats span {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(245, 196, 0, 0.15);
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            font-size: 0.92rem;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .status-badge {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(245, 245, 247, 0.08);
            color: var(--text-muted);
        }

        .badge.bg-success {
            background: rgba(88, 214, 141, 0.15);
            border-color: rgba(88, 214, 141, 0.25);
            color: #58d68d;
        }

        .badge.bg-info {
            background: rgba(245, 196, 0, 0.18);
            border-color: rgba(245, 196, 0, 0.28);
            color: var(--primary);
        }

        .badge.bg-secondary,
        .badge.bg-light {
            background: rgba(245, 245, 247, 0.1);
            border-color: rgba(255, 255, 255, 0.12);
            color: var(--text-muted);
        }

        .channel-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .channel-position {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .btn-watch {
            background: var(--primary);
            border: none;
            color: #1f1f28;
            border-radius: 999px;
            padding: 0.55rem 1.6rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            box-shadow: 0 12px 28px rgba(245, 196, 0, 0.28);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            text-transform: uppercase;
        }

        .btn-watch:hover {
            background: var(--primary-dark);
            color: #1f1f28;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-watch.disabled,
        .btn-watch:disabled {
            opacity: 0.45;
            box-shadow: none;
            cursor: not-allowed;
        }

        .alert {
            background: rgba(245, 196, 0, 0.12);
            border: 1px solid rgba(245, 196, 0, 0.4);
            color: var(--text-primary);
        }

        .spinner-border {
            color: var(--primary);
        }

        footer {
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            padding: 30px 0;
            margin-top: 40px;
        }

        footer .footer-highlight {
            color: var(--primary);
            font-weight: 600;
        }

        @media (max-width: 992px) {
            .leaderboard-section {
                padding: 2rem 1.5rem;
            }
        }

        @media (max-width: 576px) {
            .podium-card {
                transform: none !important;
            }

            .channel-card {
                flex-direction: column;
                text-align: center;
            }

            .channel-title-row {
                flex-direction: column;
                align-items: center;
            }

            .channel-stats {
                justify-content: center;
            }

            .channel-footer {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-tiktok"></i> TikTok A-Z by Kiantr
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html#lo-trinh">Lộ Trình</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#quiz">Kiểm Tra</a></li>
                    <li class="nav-item"><a class="nav-link fw-bold active-page" href="channels.html"><i class="bi bi-bar-chart-fill"></i> BXH KÊNH NỘI BỘ</a></li>
                    <li class="nav-item"><a class="nav-link fw-bold" href="honors.html"><i class="bi bi-award-fill"></i> VINH DANH</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-5">

        <section id="ranking-header" class="text-center mb-5">
            <h1 class="main-title">BẢNG XẾP HẠNG KÊNH NỘI BỘ</h1>
            <p class="lead mt-3">Cập nhật dựa trên dữ liệu Google Sheet (Follow &amp; Like) do bạn nhập và quản lý.</p>
        </section>

        <section id="leaderboard" class="leaderboard-section mb-5">
            <div class="row g-4 align-items-center">
                <div class="col-lg-4 text-center text-lg-start">
                    <h3 class="leaderboard-title">Top 3 kênh dẫn đầu</h3>
                    <p class="leaderboard-description mb-0">BXH cân bằng cả Follow và Like để vinh danh những kênh đang tăng trưởng mạnh.</p>
                </div>
                <div class="col-lg-8">
                    <div class="podium-wrapper" id="leaderboard-container">
                        <div class="text-center w-100">
                    <div class="spinner-border" role="status">
                                <span class="visually-hidden">Đang tải...</span>
                            </div>
                            <p class="mt-2 mb-0 text-white-50">Đang tính toán BXH dựa trên dữ liệu vừa nhận...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="channel-filter" class="mb-4">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="filter-card">
                        <label for="topicFilter" class="form-label fw-bold"><i class="bi bi-funnel-fill me-2"></i>Lọc theo Chủ đề:</label>
                        <select class="form-select" id="topicFilter">
                            <option value="all">-- Xem Tất Cả Chủ Đề --</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="channels-section">
            <div class="row g-4" id="channels-container">
                <div class="col-12 text-center" id="channels-loading-status">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải dữ liệu Kênh từ Google Sheets...</p>
                </div>
            </div>
            <div class="alert alert-warning text-center mt-3" id="channels-instruction">
                <i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Lưu ý:</strong> Chia sẻ Google Sheet ở chế độ <strong>Bất kỳ ai có đường liên kết</strong>, tab đặt tên <strong>Channels</strong> và nên có các cột: <code>kenh</code>, <code>chu_de</code>, <code>follow</code>, <code>like</code>, <code>team</code>, <code>link</code>, <code>avatar</code>.
            </div>
        </section>
    </main>

    <footer class="text-center">
        <div class="container">
            <p class="mb-1 footer-highlight">&copy; 2025 - Bản quyền Kiantr.</p>
            <p>Website giáo dục phi lợi nhuận. Chúc bạn thành công!</p>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // =========================================================================
        // Cấu hình Google Sheet
        // =========================================================================
        const SHEET_ID = '1vrF559kiodjQyFVS_JUsp8e6QZZruxWoh7POUt2KoFQ';
        const CHANNELS_SHEET_NAME = 'Channels';
        const CHANNELS_URL = `https://opensheet.elk.sh/${SHEET_ID}/${CHANNELS_SHEET_NAME}`;
        
        let allChannels = [];
        const topicFilter = document.getElementById('topicFilter');
        const channelsContainer = document.getElementById('channels-container');
        const leaderboardContainer = document.getElementById('leaderboard-container');

        // =========================================================================
        // Helpers
        // =========================================================================
        function normalizeHeader(header) {
            return (header || '')
                .toString()
                .trim()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '');
        }

        function normalizeRowKeys(row) {
            const normalized = {};
            Object.entries(row).forEach(([key, value]) => {
                const cleanKey = normalizeHeader(key);
                normalized[cleanKey] = value;
            });
            return normalized;
        }

        function extractHandle(link, fallbackName = '') {
            if (!link) {
                return fallbackName ? `@${normalizeHeader(fallbackName).replace(/_/g, '')}` : '@tiktok';
            }
            const handleMatch = link.match(/@([\w\.\-]+)/);
            if (handleMatch) {
                return `@${handleMatch[1]}`;
            }
            if (link.startsWith('@')) {
                return link;
            }
            const stripped = link.replace(/https?:\/\//, '').split('/');
            const candidate = stripped[stripped.length - 1];
            return candidate ? `@${candidate.replace(/@+/g, '')}` : (fallbackName ? `@${normalizeHeader(fallbackName).replace(/_/g, '')}` : '@tiktok');
        }

        function buildChannelURL(link, handle) {
            if (!link) {
                return handle && handle.startsWith('@') ? `https://www.tiktok.com/${handle}` : '#';
            }
            if (/^https?:\/\//i.test(link)) {
                return link;
            }
            if (link.startsWith('@')) {
                return `https://www.tiktok.com/${link}`;
            }
            return `https://${link}`;
        }

        function getStatusBadgeClass(status = '') {
            const normalized = status.toString().toLowerCase();
            if (normalized.includes('nổi') || normalized.includes('best')) {
                return 'badge bg-success status-badge';
            }
            if (normalized.includes('online') || normalized.includes('đang lên')) {
                return 'badge bg-info text-dark status-badge';
            }
            if (normalized.includes('chờ') || normalized.includes('mới')) {
                return 'badge bg-secondary status-badge';
            }
            return 'badge bg-light text-dark status-badge';
        }

        function parseMetricToNumber(rawValue) {
            if (rawValue === undefined || rawValue === null) {
                return null;
            }
            if (typeof rawValue === 'number') {
                return Number.isFinite(rawValue) ? rawValue : null;
            }
            const trimmed = rawValue.toString().trim();
            if (trimmed === '') {
                return null;
            }
            let normalized = trimmed
                .toUpperCase()
                .replace(/TRI[EÊ]U/g, 'M')
                .replace(/TR/g, 'B')
                .replace(/T[YỶ]/g, 'B')
                .replace(/NG[AÀ]N/g, 'K')
                .replace(/\s+/g, '');

            const match = normalized.match(/^([0-9]+(?:[.,][0-9]+)?)([KMB]?)$/);
            if (match) {
                let numberPart = match[1].replace(/,/g, '.');
                if (/\.\d{3}(?!\d)/.test(numberPart)) {
                    numberPart = numberPart.replace(/\./g, '');
                }
                const baseValue = parseFloat(numberPart);
                if (Number.isNaN(baseValue)) {
                    return null;
                }
                const suffix = match[2];
                const multiplier = suffix === 'K' ? 1_000 : suffix === 'M' ? 1_000_000 : suffix === 'B' ? 1_000_000_000 : 1;
                return baseValue * multiplier;
            }

            const digitsOnly = normalized.replace(/[^\d]/g, '');
            if (!digitsOnly) {
                return null;
            }
            return Number(digitsOnly);
        }

        function formatNumber(value) {
            if (!Number.isFinite(value)) {
                return 'Đang cập nhật';
            }
            if (value >= 1_000_000_000) {
                return `${(value / 1_000_000_000).toFixed(1).replace(/\.0$/, '')}B`;
            }
            if (value >= 1_000_000) {
                return `${(value / 1_000_000).toFixed(1).replace(/\.0$/, '')}M`;
            }
            if (value >= 1_000) {
                return `${(value / 1_000).toFixed(1).replace(/\.0$/, '')}K`;
            }
            return value.toLocaleString('vi-VN');
        }

        function formatMetric(rawValue) {
            if (rawValue === undefined || rawValue === null) {
                return 'Đang cập nhật';
            }
            if (typeof rawValue === 'number') {
                return formatNumber(rawValue);
            }
            const stringValue = rawValue.toString().trim();
            if (stringValue === '') {
                return 'Đang cập nhật';
            }
            const numeric = parseMetricToNumber(stringValue);
            if (numeric === null) {
                return stringValue;
            }
            return formatNumber(numeric);
        }

        function displayChannelError(message) {
            channelsContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center" role="alert">${message}</div></div>`;
        }

        function renderLeaderboard(channels) {
            if (!channels || channels.length === 0) {
                leaderboardContainer.innerHTML = '<div class="leaderboard-empty">Chưa có dữ liệu để tính BXH. Vui lòng nhập Follow &amp; Like trong tab Channels.</div>';
                return;
            }

            const enriched = channels.map(channel => {
                const followersRaw = channel.follow ?? channel.followers ?? channel.follower ?? channel.metric;
                const likesRaw = channel.like ?? channel.likes ?? channel.luot_thich ?? channel.hearts;
                const followersNumber = parseMetricToNumber(followersRaw) ?? 0;
                const likesNumber = parseMetricToNumber(likesRaw) ?? 0;

                const followerDisplay = formatMetric(followersRaw);
                const likeDisplay = formatMetric(likesRaw);

                const link = channel.link ?? channel.url ?? '';
                const name = channel.kenh ?? channel.channel ?? 'N/A';
                const handle = channel.handle ?? extractHandle(link, name);
                const avatar = channel.avatar ?? channel.thumbnail ?? `https://ui-avatars.com/api/?background=0d0d0d&color=ffffff&bold=true&name=${encodeURIComponent(name)}`;
                const topic = channel.chu_de ?? channel.topic ?? '';
                const team = channel.team ?? channel.bo_phan ?? channel.doi_nhom ?? '';

                return {
                    ...channel,
                    name,
                    handle,
                    link,
                    avatar,
                    topic,
                    team,
                    followersNumber,
                    likesNumber,
                    followerDisplay,
                    likeDisplay
                };
            }).filter(item => item.followersNumber > 0 || item.likesNumber > 0);

            if (enriched.length === 0) {
                leaderboardContainer.innerHTML = '<div class="leaderboard-empty">Top 3 đang chờ dữ liệu hợp lệ. Hãy nhập Follow/Like dạng số trong Google Sheet.</div>';
                return;
            }

            const maxFollowers = Math.max(...enriched.map(item => item.followersNumber), 1);
            const maxLikes = Math.max(...enriched.map(item => item.likesNumber), 1);

            enriched.forEach(item => {
                const followerScore = maxFollowers ? item.followersNumber / maxFollowers : 0;
                const likeScore = maxLikes ? item.likesNumber / maxLikes : 0;
                item.score = followerScore + likeScore;
            });

            enriched.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                if (b.followersNumber !== a.followersNumber) {
                    return b.followersNumber - a.followersNumber;
                }
                return b.likesNumber - a.likesNumber;
            });

            const topThree = enriched.slice(0, 3);
            const html = topThree.map((channel, index) => {
                const rank = index + 1;
                const topicLabel = channel.topic ? `#${channel.topic}` : 'Đang cập nhật chủ đề';
                const teamLabel = channel.team ? `Team: ${channel.team}` : 'Team đang cập nhật';
                const channelUrl = buildChannelURL(channel.link, channel.handle);
                const disabledAttrs = channelUrl === '#' ? 'tabindex="-1" aria-disabled="true"' : '';
                const buttonClasses = channelUrl === '#' ? 'btn btn-watch disabled opacity-50' : 'btn btn-watch';

                return `
                    <div class="podium-card rank-${rank}">
                        <div class="podium-rank">#${rank}</div>
                        <div class="podium-avatar">
                            <img src="${channel.avatar}" alt="Avatar ${channel.name}" loading="lazy" onerror="this.src='https://ui-avatars.com/api/?background=0d0d0d&color=ffffff&bold=true&name=${encodeURIComponent(channel.name)}';">
                        </div>
                        <h4 class="podium-name">${channel.name}</h4>
                        <p class="podium-handle">${channel.handle}</p>
                        <div class="podium-stats">
                            <span class="metric-chip"><i class="bi bi-people-fill"></i>${channel.followerDisplay}</span>
                            <span class="metric-chip"><i class="bi bi-heart-fill"></i>${channel.likeDisplay}</span>
                        </div>
                        <div class="podium-meta">
                            <small>${topicLabel}</small>
                            <small>${teamLabel}</small>
                        </div>
                        <a href="${channelUrl}" target="_blank" rel="noopener" class="${buttonClasses}" ${disabledAttrs}>
                            <i class="bi bi-tiktok"></i> Xem kênh
                        </a>
                    </div>
                `;
            }).join('');

            leaderboardContainer.innerHTML = html;
        }

        function displayChannels(channels) {
            channelsContainer.innerHTML = '';
            
            if (!channels || channels.length === 0) {
                channelsContainer.innerHTML = '<div class="col-12 text-center"><div class="alert alert-warning" role="alert">Không tìm thấy kênh nào phù hợp với bộ lọc.</div></div>';
                return;
            }

            channels.forEach(channel => {
                const channelName = channel.kenh ?? channel.channel ?? 'N/A';
                const topicRaw = channel.chu_de ?? channel.topic ?? '';
                const topicLabel = topicRaw ? `# ${topicRaw}` : 'Chủ đề đang cập nhật';
                const team = channel.team ?? channel.bo_phan ?? channel.doi_nhom ?? 'Đang cập nhật';
                const followersRaw = channel.follow ?? channel.followers ?? channel.follower ?? channel.metric;
                const likesRaw = channel.like ?? channel.likes ?? channel.luot_thich ?? channel.hearts;
                const followers = formatMetric(followersRaw);
                const likes = formatMetric(likesRaw);
                const link = channel.link ?? channel.url ?? '';
                const handle = channel.handle ?? extractHandle(link, channelName);
                const channelUrl = buildChannelURL(link, handle);
                const avatar = channel.avatar ?? channel.thumbnail ?? `https://ui-avatars.com/api/?background=0d0d0d&color=ffffff&bold=true&name=${encodeURIComponent(channelName)}`;
                const statusBadge = channel.trang_thai ?? channel.status ?? 'Hoạt động';
                const badgeClass = getStatusBadgeClass(statusBadge);
                
                channelsContainer.innerHTML += `
                    <div class="col-lg-4 col-md-6">
                        <div class="card channel-card h-100">
                            <div class="channel-avatar">
                                <img src="${avatar}" alt="Avatar ${channelName}" loading="lazy" onerror="this.src='https://ui-avatars.com/api/?background=0d0d0d&color=ffffff&bold=true&name=${encodeURIComponent(channelName)}';">
                            </div>
                            <div class="channel-content">
                                <div class="channel-title-row">
                                    <div>
                                        <div class="channel-name">${channelName}</div>
                                        <div class="channel-handle">${handle}</div>
                                    </div>
                                    <span class="${badgeClass}">${statusBadge}</span>
                                </div>
                                <div class="channel-topic">${topicLabel}</div>
                                <div class="channel-stats">
                                    <span><i class="bi bi-people-fill"></i>${followers} Followers</span>
                                    <span><i class="bi bi-heart-fill"></i>${likes} Likes</span>
                                </div>
                                <div class="channel-footer">
                                    <small class="channel-position">Team: ${team}</small>
                                    <a href="${channelUrl}" target="_blank" class="btn btn-watch ${channelUrl === '#' ? 'disabled opacity-50' : ''}" rel="noopener" ${channelUrl === '#' ? 'tabindex="-1" aria-disabled="true"' : ''}>
                                        <i class="bi bi-tiktok"></i> Xem kênh
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function populateFilters(channels) {
            if (!topicFilter) {
                return;
            }
            const topics = new Set();
            channels.forEach(channel => {
                const topic = channel.chu_de ?? channel.topic ?? '';
                if (topic && topic.trim()) {
                    topics.add(topic.trim());
                }
            });
            
            topicFilter.innerHTML = '<option value="all">-- Xem Tất Cả Chủ Đề --</option>';
            Array.from(topics)
                .sort((a, b) => a.localeCompare(b, 'vi', { sensitivity: 'base' }))
                .forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    topicFilter.appendChild(option);
                });
        }

        function handleFilter() {
            if (!topicFilter) {
                return;
            }
            const selectedTopic = topicFilter.value;
            if (selectedTopic === 'all') {
                displayChannels(allChannels);
                return;
            }
            const filteredChannels = allChannels.filter(channel => {
                const topic = channel.chu_de ?? channel.topic ?? '';
                return topic && topic.trim() === selectedTopic;
            });
            displayChannels(filteredChannels);
        }

        async function fetchChannels() {
            try {
                const response = await fetch(CHANNELS_URL);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                
                allChannels = data
                    .map(normalizeRowKeys)
                    .filter(row => Object.values(row).some(val => val && val.toString().trim() !== ''));
                
                if (allChannels.length === 0) {
                    renderLeaderboard([]);
                    displayChannelError('Không tìm thấy dữ liệu trong tab Channels. Vui lòng kiểm tra lại Google Sheet.');
                    return;
                }

                populateFilters(allChannels);
                renderLeaderboard(allChannels);
                displayChannels(allChannels);
            } catch (error) {
                console.error('Lỗi Fetch Channels:', error);
                renderLeaderboard([]);
                displayChannelError('Lỗi kết nối. Không thể tải danh sách kênh. Hãy kiểm tra quyền chia sẻ Google Sheet.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchChannels();
            if (topicFilter) {
                topicFilter.addEventListener('change', handleFilter);
            }
        });

    </script>

</body>
</html>
