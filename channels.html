<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Xếp Hạng Kênh Nội Bộ | TikTok A-Z by Kiantr</title>
    <meta name="description" content="BXH kênh TikTok nội bộ, top 3 podium và bảng hạng chi tiết với trạng thái dịch chuyển theo thời gian.">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-base: #fdfcf7;
            --bg-surface: #ffffff;
            --bg-muted: #f6f1d1;
            --primary: #f5c400;
            --primary-dark: #dba702;
            --ink: #1d1d1f;
            --ink-muted: rgba(29, 29, 31, 0.65);
            --border: rgba(0, 0, 0, 0.08);
            --shadow-sm: 0 12px 24px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 18px 38px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 28px 70px rgba(0, 0, 0, 0.16);
        }

        body {
            background: var(--bg-base);
            color: var(--ink);
            font-family: 'Inter', 'Roboto', sans-serif;
            line-height: 1.6;
        }

        a {
            color: var(--ink);
            text-decoration: none;
        }

        a:hover,
        a:focus {
            color: var(--primary-dark);
        }

        .navbar {
            background: rgba(255, 255, 255, 0.92) !important;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(12px);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.04em;
            color: var(--ink) !important;
        }

        .nav-link {
            color: var(--ink-muted) !important;
            font-weight: 600;
        }

        .nav-link:hover,
        .nav-link:focus,
        .nav-link.active-page {
            color: var(--primary-dark) !important;
        }

        .page-header {
            text-align: center;
            margin-top: 3rem;
            margin-bottom: 2.5rem;
        }

        .page-header h1 {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 800;
            color: var(--ink);
            margin-bottom: 0.75rem;
        }

        .page-header p {
            color: var(--ink-muted);
        }

        .podium {
            display: grid;
            gap: clamp(0.9rem, 2.5vw, 1.4rem);
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            margin-bottom: 2.2rem;
        }

        .podium-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: clamp(1.15rem, 2.8vw, 1.5rem);
            position: relative;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .podium-card.rank-1 {
            background: linear-gradient(140deg, rgba(245, 196, 0, 0.95), rgba(255, 244, 164, 0.9));
            color: var(--ink);
            transform: translateY(-6px);
        }

        .podium-card.rank-2,
        .podium-card.rank-3 {
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.95), rgba(246, 241, 209, 0.85));
        }

        .podium-rank {
            position: absolute;
            top: -20px;
            left: 20px;
            background: var(--ink);
            color: #fff;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 800;
            box-shadow: var(--shadow-sm);
        }

        .podium-card.rank-1 .podium-rank {
            background: #141414;
            color: var(--primary);
        }

        .podium-name {
            font-size: clamp(1.05rem, 3vw, 1.2rem);
            font-weight: 700;
        }

        .podium-handle {
            color: var(--ink-muted);
        }

        .podium-metric {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.75rem;
            border-radius: 999px;
            background: rgba(29, 29, 31, 0.08);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .podium-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            color: var(--ink-muted);
            font-size: 0.85rem;
        }

        .search-panel {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 1.4rem;
            margin-bottom: 1.8rem;
            box-shadow: var(--shadow-sm);
        }

        .search-panel label {
            font-weight: 600;
            color: var(--ink-muted);
        }

        .search-panel input {
            border-radius: 14px;
            padding: 0.7rem 1.1rem;
            border: 1px solid var(--border);
        }

        .search-panel input:focus {
            border-color: rgba(245, 196, 0, 0.6);
            box-shadow: 0 0 0 0.15rem rgba(245, 196, 0, 0.25);
        }

        .rank-list {
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
        }

        .rank-row {
            display: grid;
            grid-template-columns: 64px 1fr 120px;
            gap: 0.85rem;
            align-items: center;
            padding: 1rem 1.2rem;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 18px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .rank-row:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .rank-number {
            font-size: 1.45rem;
            font-weight: 800;
            color: var(--ink);
            text-align: center;
        }

        .rank-content h5 {
            margin-bottom: 0.25rem;
            font-weight: 700;
            font-size: 1rem;
        }

        .rank-handle,
        .rank-topic {
            color: var(--ink-muted);
            font-size: 0.85rem;
        }

        .rank-meta {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-top: 0.35rem;
        }

        .rank-meta span {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-weight: 600;
            color: var(--ink);
            font-size: 0.85rem;
        }

        .rank-trend {
            text-align: right;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .rank-trend.up {
            color: #1a6f45;
        }

        .rank-trend.down {
            color: #c0392b;
        }

        .rank-trend.same {
            color: var(--ink-muted);
        }

        .rank-trend span {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }

        .alert {
            background: rgba(245, 196, 0, 0.18);
            border: 1px solid rgba(245, 196, 0, 0.4);
            color: var(--ink);
        }

        footer {
            background: var(--ink);
            color: rgba(255, 255, 255, 0.72);
            padding: 32px 0 90px;
            margin-top: 40px;
        }

        footer .footer-highlight {
            color: var(--primary);
            font-weight: 700;
        }

        .floating-cta-group {
            position: fixed;
            right: clamp(16px, 4vw, 28px);
            bottom: calc(env(safe-area-inset-bottom) + 96px);
            z-index: 1200;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .floating-cta {
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            padding: 0.55rem 1rem;
            border-radius: 999px;
            background: #111;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.28);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .floating-cta i {
            font-size: 1.05rem;
        }

        .floating-cta:hover {
            transform: translateY(-3px);
            background: var(--primary-dark);
            color: #111;
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.32);
        }

        .mobile-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--ink);
            display: none;
            justify-content: space-around;
            padding: 0.55rem 0.75rem calc(env(safe-area-inset-bottom) + 0.55rem);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.25);
            z-index: 1030;
        }

        .mobile-nav a {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            color: rgba(255, 255, 255, 0.72);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .mobile-nav a.active {
            color: var(--primary);
        }

        .mobile-nav i {
            font-size: 1.35rem;
        }

        @media (min-width: 769px) {
            .floating-cta-group {
                bottom: 32px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-bottom: 88px;
            }
            .navbar {
                display: none;
            }
            .mobile-nav {
                display: flex;
            }
            .rank-row {
                grid-template-columns: 52px 1fr;
                grid-template-rows: auto auto;
                gap: 0.45rem;
                padding: 0.9rem 1rem;
            }
            .rank-number {
                font-size: 1.3rem;
            }
            .rank-content h5 {
                font-size: 0.95rem;
            }
            .rank-handle,
            .rank-topic,
            .rank-meta span,
            .rank-trend {
                font-size: 0.8rem;
            }
            .rank-trend {
                grid-column: 2;
                text-align: left;
            }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-tiktok"></i> TikTok A-Z by Kiantr
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active-page fw-bold" href="index.html"><i class="bi bi-bar-chart-fill"></i> BXH Kênh</a></li>
                    <li class="nav-item"><a class="nav-link" href="learning.html"><i class="bi bi-journal-play"></i> Học Thêm</a></li>
                    <li class="nav-item"><a class="nav-link" href="roadmap.html">Lộ Trình</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="page-header container">
        <h1>BẢNG XẾP HẠNG KÊNH NỘI BỘ</h1>
        <p>Cập nhật theo dữ liệu Follow &amp; Like mới nhất. Theo dõi sự dịch chuyển thứ hạng của đội ngũ mỗi lần bạn làm mới.</p>
    </header>

    <main class="container pb-5">

        <section id="leaderboard" class="mb-4">
            <div id="podium-wrapper" class="podium">
                <!-- populated by JS -->
            </div>
        </section>

        <section class="search-panel">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <label for="channelSearch" class="form-label"><i class="bi bi-search me-2"></i>Tìm kiếm kênh</label>
                    <input type="text" class="form-control" id="channelSearch" placeholder="Nhập tên kênh hoặc @handle">
                </div>
            </div>
        </section>

        <section>
            <div id="rank-list" class="rank-list"></div>
            <div id="channels-loading" class="text-center py-4">
                <div class="spinner-border" role="status"><span class="visually-hidden">Đang tải...</span></div>
                <p class="mt-3 text-muted">Đang tải dữ liệu kênh nội bộ...</p>
            </div>
            <div id="channels-empty" class="alert mt-3 d-none">
                Không có dữ liệu kênh. Vui lòng kiểm tra tab <strong>Channels</strong> trong Google Sheet.
            </div>
        </section>

    </main>

    <div class="floating-cta-group">
        <a class="floating-cta" href="https://seazen.vn/submitkenh" target="_blank" rel="noopener">
            <i class="bi bi-send-check-fill"></i><span>Gửi kênh</span>
        </a>
        <a class="floating-cta" href="https://seazen.vn/submitnoidung" target="_blank" rel="noopener">
            <i class="bi bi-pencil-square"></i><span>Gửi nội dung</span>
        </a>
    </div>

    <footer class="text-center">
        <div class="container">
            <p class="mb-1 footer-highlight">&copy; 2025 - Bản quyền Kiantr.</p>
            <p>Website giáo dục phi lợi nhuận. Chúc bạn thành công!</p>
        </div>
    </footer>

    <nav class="mobile-nav" data-page="ranking">
        <a href="index.html" class="active">
            <i class="bi bi-bar-chart-fill"></i>
            <span>BXH</span>
        </a>
        <a href="learning.html">
            <i class="bi bi-mortarboard-fill"></i>
            <span>Học thêm</span>
        </a>
        <a href="roadmap.html">
            <i class="bi bi-map"></i>
            <span>Lộ trình</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="visitor-modal.js"></script>

    <script>
        const SHEET_ID = '1vrF559kiodjQyFVS_JUsp8e6QZZruxWoh7POUt2KoFQ';
        const CHANNELS_SHEET_NAME = 'Channels';
        const CHANNELS_URL = `https://opensheet.elk.sh/${SHEET_ID}/${CHANNELS_SHEET_NAME}`;
        const RANK_STORAGE_KEY = 'tiktokseazen_rankings_v1';

        const podiumWrapper = document.getElementById('podium-wrapper');
        const rankList = document.getElementById('rank-list');
        const loadingIndicator = document.getElementById('channels-loading');
        const emptyAlert = document.getElementById('channels-empty');
        const searchInput = document.getElementById('channelSearch');

        let rankedChannels = [];
        let rankChangeMap = {};

        function normalizeHeader(header) {
            return (header || '').toString().trim().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '');
        }

        function normalizeRowKeys(row) {
            const normalized = {};
            Object.entries(row).forEach(([key, value]) => {
                const cleanKey = normalizeHeader(key);
                normalized[cleanKey] = value;
            });
            return normalized;
        }

        function extractHandle(link, fallbackName = '') {
            if (!link) {
                return fallbackName ? `@${normalizeHeader(fallbackName).replace(/_/g, '')}` : '@tiktok';
            }
            const handleMatch = link.match(/@([\w\.\-]+)/);
            if (handleMatch) {
                return `@${handleMatch[1]}`;
            }
            if (link.startsWith('@')) {
                return link;
            }
            const stripped = link.replace(/https?:\/\//, '').split('/');
            const candidate = stripped[stripped.length - 1];
            return candidate ? `@${candidate.replace(/@+/g, '')}` : (fallbackName ? `@${normalizeHeader(fallbackName).replace(/_/g, '')}` : '@tiktok');
        }

        function buildChannelURL(link, handle) {
            if (!link) {
                return handle && handle.startsWith('@') ? `https://www.tiktok.com/${handle}` : '#';
            }
            if (/^https?:\/\//i.test(link)) {
                return link;
            }
            if (link.startsWith('@')) {
                return `https://www.tiktok.com/${link}`;
            }
            return `https://${link}`;
        }

        function parseMetricToNumber(rawValue) {
            if (rawValue === undefined || rawValue === null) return 0;
            if (typeof rawValue === 'number') return Number.isFinite(rawValue) ? rawValue : 0;
            let value = rawValue.toString().trim().toUpperCase();
            if (value === '') return 0;
            value = value
                .replace(/TRI[EÊ]U/g, 'M')
                .replace(/T[YỶ]/g, 'B')
                .replace(/NG[AÀ]N/g, 'K')
                .replace(/\s+/g, '');
            const match = value.match(/^([0-9]+(?:[.,][0-9]+)?)([KMB]?)$/);
            if (match) {
                let numberPart = match[1].replace(',', '.');
                const base = parseFloat(numberPart);
                if (Number.isNaN(base)) return 0;
                const suffix = match[2];
                const multiplier = suffix === 'K' ? 1_000 : suffix === 'M' ? 1_000_000 : suffix === 'B' ? 1_000_000_000 : 1;
                return base * multiplier;
            }
            const digits = value.replace(/[^\d]/g, '');
            return digits ? Number(digits) : 0;
        }

        function formatMetric(value) {
            if (value === null || value === undefined) return 'Đang cập nhật';
            if (typeof value === 'number') return formatNumber(value);
            const numeric = parseMetricToNumber(value);
            if (!numeric) return value;
            return formatNumber(numeric);
        }

        function formatNumber(value) {
            if (!Number.isFinite(value)) return 'Đang cập nhật';
            if (value >= 1_000_000) return `${(value / 1_000_000).toFixed(1).replace(/\.0$/, '')}M`;
            if (value >= 1_000) return `${(value / 1_000).toFixed(1).replace(/\.0$/, '')}K`;
            return value.toLocaleString('vi-VN');
        }

        function computeScore(channel) {
            return channel.followersNumber + channel.likesNumber;
        }

        function prepareChannels(rawChannels) {
            const prepared = rawChannels.map(row => {
                const name = row.kenh ?? row.channel ?? 'Ẩn danh';
                const link = row.link ?? row.url ?? '';
                const handle = row.handle ?? extractHandle(link, name);
                const followersNumber = parseMetricToNumber(row.follow ?? row.followers ?? row.follower ?? row.metric);
                const likesNumber = parseMetricToNumber(row.like ?? row.likes ?? row.luot_thich ?? row.hearts);
                const followersDisplay = formatMetric(row.follow ?? row.followers ?? row.follower ?? row.metric);
                const likesDisplay = formatMetric(row.like ?? row.likes ?? row.luot_thich ?? row.hearts);
                return {
                    name,
                    handle,
                    topic: row.chu_de ?? row.topic ?? 'Đang cập nhật',
                    team: row.team ?? row.bo_phan ?? row.doi_nhom ?? 'Đang cập nhật',
                    followersNumber,
                    likesNumber,
                    followersDisplay,
                    likesDisplay,
                    link: buildChannelURL(link, handle),
                    position: row.dinh_vi ?? row.position ?? ''
                };
            });

            return prepared
                .filter(item => item.name && item.name.toString().trim() !== '')
                .sort((a, b) => {
                    const scoreDiff = computeScore(b) - computeScore(a);
                    if (scoreDiff !== 0) return scoreDiff;
                    if (b.followersNumber !== a.followersNumber) return b.followersNumber - a.followersNumber;
                    return b.likesNumber - a.likesNumber;
                });
        }

        function computeRankChanges(list) {
            const previousRaw = localStorage.getItem(RANK_STORAGE_KEY);
            const previous = previousRaw ? JSON.parse(previousRaw) : {};
            const next = {};
            rankChangeMap = {};

            list.forEach((channel, index) => {
                const rank = index + 1;
                const key = channel.handle || channel.name;
                next[key] = rank;
                if (previous && previous[key]) {
                    rankChangeMap[key] = previous[key] - rank;
                } else {
                    rankChangeMap[key] = null; // new data point
                }
            });

            localStorage.setItem(RANK_STORAGE_KEY, JSON.stringify(next));
        }

        function renderPodium(list) {
            podiumWrapper.innerHTML = '';
            if (list.length === 0) return;
            list.slice(0, 3).forEach((channel, index) => {
                const rank = index + 1;
                const topic = channel.topic ? `#${channel.topic}` : 'Đang cập nhật';
                const team = channel.team !== 'Đang cập nhật' ? channel.team : '';
                const trend = rankChangeMap[channel.handle] ?? rankChangeMap[channel.name];
                const trendLabel = (() => {
                    if (trend === null) return '<span class="text-muted small">Mới vào bảng</span>';
                    if (trend > 0) return `<span class="text-success small"><i class="bi bi-arrow-up-short"></i> +${trend}</span>`;
                    if (trend < 0) return `<span class="text-danger small"><i class="bi bi-arrow-down-short"></i> ${trend}</span>`;
                    return '<span class="text-muted small"><i class="bi bi-dash"></i> Giữ hạng</span>';
                })();

                const card = document.createElement('div');
                card.className = `podium-card rank-${rank}`;
                card.innerHTML = `
                    <div class="podium-rank">#${rank}</div>
                    <div>
                        <div class="podium-name">${channel.name}</div>
                        <div class="podium-handle">${channel.handle}</div>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="podium-metric"><i class="bi bi-people-fill"></i>${channel.followersDisplay}</span>
                        <span class="podium-metric"><i class="bi bi-heart-fill"></i>${channel.likesDisplay}</span>
                    </div>
                    <div class="podium-meta">
                        <span>${topic}</span>
                        ${team ? `<span>Team: ${team}</span>` : ''}
                    </div>
                    <div class="small">${trendLabel}</div>
                    <div class="mt-auto">
                        <a href="${channel.link}" class="btn btn-dark btn-sm w-100 ${channel.link === '#' ? 'disabled' : ''}" target="_blank" rel="noopener">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Xem kênh
                        </a>
                    </div>
                `;
                podiumWrapper.appendChild(card);
            });
        }

        function getTrendClass(diff) {
            if (diff === null) return 'same';
            if (diff > 0) return 'up';
            if (diff < 0) return 'down';
            return 'same';
        }

        function getTrendLabel(diff) {
            if (diff === null) return '<span><i class="bi bi-stars"></i> Mới</span>';
            if (typeof diff !== 'number') return '';
            if (diff > 0) return `<span><i class="bi bi-arrow-up-short"></i> +${diff}</span>`;
            if (diff < 0) return `<span><i class="bi bi-arrow-down-short"></i> ${diff}</span>`;
            return '';
        }

        function renderRankList(list) {
            rankList.innerHTML = '';
            list.forEach(channel => {
                const row = document.createElement('div');
                row.className = 'rank-row';
                row.dataset.name = `${channel.name} ${channel.handle} ${channel.topic}`.toLowerCase();
                const trend = rankChangeMap[channel.handle] ?? rankChangeMap[channel.name];
                const trendLabel = getTrendLabel(trend);
                const trendClass = getTrendClass(trend);
                row.innerHTML = `
                    <div class="rank-number">#${channel.rank}</div>
                    <div class="rank-content">
                        <h5>${channel.name}</h5>
                        <div class="rank-handle">${channel.handle}</div>
                        <div class="rank-meta">
                            <span><i class="bi bi-people-fill"></i>${channel.followersDisplay}</span>
                            <span><i class="bi bi-heart-fill"></i>${channel.likesDisplay}</span>
                            ${channel.topic ? `<span><i class="bi bi-hash"></i>${channel.topic}</span>` : ''}
                            ${channel.team && channel.team !== 'Đang cập nhật' ? `<span><i class="bi bi-people"></i>${channel.team}</span>` : ''}
                        </div>
                    </div>
                    <div class="rank-trend ${trendClass} ${trendLabel ? '' : 'd-none'}">
                        ${trendLabel}
                    </div>
                `;
                row.addEventListener('click', () => {
                    if (channel.link && channel.link !== '#') {
                        window.open(channel.link, '_blank', 'noopener');
                    }
                });
                rankList.appendChild(row);
            });
        }

        function applySearchFilter() {
            const keyword = searchInput.value.trim().toLowerCase();
            rankList.querySelectorAll('.rank-row').forEach(row => {
                const match = row.dataset.name.includes(keyword);
                row.style.display = match ? '' : 'none';
            });
        }

        async function fetchChannels() {
            try {
                const response = await fetch(CHANNELS_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const rows = data
                    .map(normalizeRowKeys)
                    .filter(row => Object.values(row).some(val => val && val.toString().trim() !== ''));

                rankedChannels = prepareChannels(rows);
                if (rankedChannels.length === 0) {
                    emptyAlert.classList.remove('d-none');
                    return;
                }

                computeRankChanges(rankedChannels);

                rankedChannels = rankedChannels.map((channel, index) => ({
                    ...channel,
                    rank: index + 1
                }));

                renderPodium(rankedChannels);

                const rest = rankedChannels.slice(3);
                renderRankList(rest);
            } catch (error) {
                console.error('Lỗi Fetch Channels:', error);
                emptyAlert.classList.remove('d-none');
                emptyAlert.textContent = 'Không thể tải dữ liệu. Hãy kiểm tra quyền chia sẻ Google Sheet.';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchChannels();
            searchInput.addEventListener('input', applySearchFilter);
        });
    </script>

</body>
</html>
